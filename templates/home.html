{% extends 'base.html' %}

{% block title %}Inicio - CINAF{% endblock %}

{% block content %}

{% load static %}

<div class="text-center my-4">
    <img src="{% static 'img/cinaf_logo.png' %}" alt="Logo CINAF" style="max-height: 200px;">
</div>



<div class="container">

    <div class="row">
        <div class="col-md-6"> 
            <div class="card text-white bg-success mb-3 shadow">
                <div class="card-body">
                    <h5 class="card-title">Socios Totales</h5>
                    <p class="card-text fs-3">{{ total_socios }}</p>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card text-white bg-info mb-3 shadow">
                <div class="card-body">
                    <h5 class="card-title">Asistencias Hoy</h5>
                    <p class="card-text fs-3">{{ asistencias_hoy }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Gráfico de Asistencias por Hora -->
    <h2 class="mt-5">Asistencias por Hora (Promedio Diario)</h2>
    
    <!-- Filtro para el gráfico de horas -->
    <div class="card shadow p-4 mb-4">
        <h5>Rango de Fechas</h5>
        <form method="get" class="row g-3 align-items-end">
            <!-- Mantener otros parámetros de filtrado -->
            <input type="hidden" name="grupo" value="{{ grupo }}">
            {% if request.GET.filtro %}
            <input type="hidden" name="filtro" value="{{ request.GET.filtro }}">
            {% endif %}
            <div class="col-md-4">
                <label for="fecha_inicio_hora" class="form-label">Fecha de inicio</label>
                <input type="date" class="form-control" id="fecha_inicio_hora" name="fecha_inicio_hora" 
                       value="{{ request.GET.fecha_inicio_hora|default:'' }}">
            </div>
            <div class="col-md-4">
                <label for="fecha_fin_hora" class="form-label">Fecha de fin</label>
                <input type="date" class="form-control" id="fecha_fin_hora" name="fecha_fin_hora"
                       value="{{ request.GET.fecha_fin_hora|default:'' }}">
            </div>
            <div class="col-md-4">
                <button type="submit" name="actualizar_horas" class="btn btn-primary me-2">
                    <i class="fas fa-filter"></i> Aplicar Filtro
                </button>
                <a href="?" class="btn btn-outline-secondary">
                    <i class="fas fa-sync"></i> Limpiar
                </a>
            </div>
        </form>
    </div>
    
    <div class="card shadow p-4 mb-5">
        <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
            <canvas id="asistenciasHoraChart"></canvas>
        </div>
    </div>

    <!-- Gráfico de Asistencias por Mes -->
    <h2 class="mt-5">Asistencias por Mes</h2>
    
    <!-- Filtro para el gráfico de meses -->
    <div class="card shadow p-4 mb-4">
        <h5>Rango de Fechas</h5>
        <form method="get" class="row g-3 align-items-end">
            <!-- Mantener otros parámetros de filtrado -->
            {% if request.GET.filtro %}
            <input type="hidden" name="filtro" value="{{ request.GET.filtro }}">
            {% endif %}
            <div class="col-md-4">
                <label for="fecha_inicio_mes" class="form-label">Fecha de inicio</label>
                <input type="date" class="form-control" id="fecha_inicio_mes" name="fecha_inicio_mes" 
                       value="{{ request.GET.fecha_inicio_mes|default:'' }}">
            </div>
            <div class="col-md-4">
                <label for="fecha_fin_mes" class="form-label">Fecha de fin</label>
                <input type="date" class="form-control" id="fecha_fin_mes" name="fecha_fin_mes"
                       value="{{ request.GET.fecha_fin_mes|default:'' }}">
            </div>
            <div class="col-md-4">
                <button type="submit" name="actualizar_meses" class="btn btn-primary me-2">
                    <i class="fas fa-filter"></i> Aplicar Filtro
                </button>
                <a href="?" class="btn btn-outline-secondary">
                    <i class="fas fa-sync"></i> Limpiar
                </a>
            </div>
        </form>
    </div>
    
    <div class="card shadow p-4 mb-5">
        <h3 class="mb-4">Asistencias por Mes</h3>
        <div class="chart-container" style="position: relative; height: 400px; width: 100%;">
            <canvas id="asistenciasMesChart" style="width: 100%; height: 100%;"></canvas>
        </div>
    </div>
    
    <script>
    // Función para formatear fecha a YYYY-MM-DD
    function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // Establecer fechas por defecto solo si no hay parámetros en la URL
    document.addEventListener('DOMContentLoaded', function() {
        // Verificar si hay parámetros en la URL
        const urlParams = new URLSearchParams(window.location.search);
        
        // Si no hay parámetros, establecer valores por defecto
        if (urlParams.toString() === '') {
            const hoy = new Date();
            
            // Para el gráfico de horas (mostrar solo el día actual por defecto)
            const fechaFinHora = document.getElementById('fecha_fin_hora');
            const fechaInicioHora = document.getElementById('fecha_inicio_hora');
            
            if (fechaFinHora && fechaInicioHora) {
                const hoyStr = formatDate(hoy);
                fechaFinHora.value = hoyStr;
                fechaInicioHora.value = hoyStr;
                
                // Enviar el formulario automáticamente para cargar los datos
                const form = fechaInicioHora.closest('form');
                if (form) {
                    form.submit();
                }
            }
            
            // Para el gráfico de meses (últimos 12 meses completos)
            const fechaFinMes = document.getElementById('fecha_fin');
            const fechaInicioMes = document.getElementById('fecha_inicio');
            
            if (fechaFinMes && fechaInicioMes) {
                // Último día del mes actual
                const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
                
                // Primer día del mes hace 11 meses
                let anioInicio = hoy.getFullYear();
                let mesInicio = hoy.getMonth() - 11;
                if (mesInicio <= 0) {
                    mesInicio += 12;
                    anioInicio--;
                }
                const primerDiaHace11Meses = new Date(anioInicio, mesInicio - 1, 1);
                
                fechaFinMes.value = formatDate(ultimoDiaMes);
                fechaInicioMes.value = formatDate(primerDiaHace11Meses);
            }
        }
    });
    </script>

    <script>
    document.addEventListener('DOMContentLoaded', function() {
        var ctx = document.getElementById('asistenciasHoraChart');
        if (ctx) {
            // Obtener datos de las variables de Django
            var horas = JSON.parse('{{ horas|safe }}');
            var cantidades = JSON.parse('{{ cantidades|safe }}');
            
            console.log('Horas:', horas);
            console.log('Cantidades:', cantidades);
            
            var asistenciasChart = new Chart(ctx.getContext('2d'), {
                type: 'bar',
                data: {
                    labels: horas,
                    datasets: [{
                        label: 'Promedio de Asistencias por Hora',
                        data: cantidades,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                stepSize: 1,
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'Promedio de Asistencias'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Hora del Día'
                            }
                        }
                    },
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false
                        },
                        title: {
                            display: true,
                            text: 'Asistencias Promedio por Hora del Día'
                        }
                    }
                }
            });
        }
    });
    </script>
    
    <!-- Script para el gráfico de asistencias por mes -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        console.log('Inicializando gráfico de asistencias por mes...');
        
        var ctxMes = document.getElementById('asistenciasMesChart');
        if (!ctxMes) {
            console.error('No se encontró el elemento canvas para el gráfico de asistencias por mes');
            return;
        }
        
        try {
            // Obtener datos de las variables de Django
            var mesesEtiquetas = [];
            var cantidadesMes = [];
            
            try {
                // Parsear los datos JSON
                mesesEtiquetas = JSON.parse('{{ meses_etiquetas|escapejs }}');
                cantidadesMes = JSON.parse('{{ cantidades_mes|escapejs }}');
                
                console.log('Datos recibidos para gráfico de meses:');
                console.log('Meses:', mesesEtiquetas);
                console.log('Cantidades:', cantidadesMes);
                
                // Verificar que los datos sean arrays
                if (!Array.isArray(mesesEtiquetas) || !Array.isArray(cantidadesMes)) {
                    console.error('Error: Los datos no son arrays válidos');
                    console.error('Tipo de mesesEtiquetas:', typeof mesesEtiquetas);
                    console.error('Tipo de cantidadesMes:', typeof cantidadesMes);
                    return;
                }
                
                // Verificar que los arrays tengan la misma longitud
                if (mesesEtiquetas.length !== cantidadesMes.length) {
                    console.warn('Los arrays de etiquetas y datos tienen longitudes diferentes:', 
                        mesesEtiquetas.length, 'vs', cantidadesMes.length);
                    // Ajustar la longitud al mínimo de ambos arrays
                    var minLength = Math.min(mesesEtiquetas.length, cantidadesMes.length);
                    if (minLength === 0) {
                        console.error('No hay datos para mostrar en el gráfico');
                        return;
                    }
                    mesesEtiquetas = mesesEtiquetas.slice(0, minLength);
                    cantidadesMes = cantidadesMes.slice(0, minLength);
                }
                
                console.log('Inicializando gráfico de asistencias por mes con', mesesEtiquetas.length, 'puntos de datos');
                
            } catch (e) {
                console.error('Error al procesar los datos del gráfico:', e);
                return;
            }
            
            // Configuración del gráfico
            var config = {
                type: 'bar',
                data: {
                    labels: mesesEtiquetas,
                    datasets: [{
                        label: 'Socios Únicos',
                        data: cantidadesMes,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1,
                        borderRadius: 4,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cantidad de Socios Únicos',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                }
                            },
                            grid: {
                                display: true,
                                drawBorder: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            },
                            ticks: {
                                stepSize: 1,
                                precision: 0,
                                font: {
                                    size: 11
                                }
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Mes',
                                font: {
                                    weight: 'bold',
                                    size: 12
                                }
                            },
                            grid: {
                                display: false
                            },
                            ticks: {
                                autoSkip: false,
                                maxRotation: 45,
                                minRotation: 45,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                pointStyle: 'circle',
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            padding: 12,
                            displayColors: false,
                            callbacks: {
                                label: function(context) {
                                    return 'Asistencias: ' + context.parsed.y;
                                }
                            }
                        },
                        title: {
                            display: false
                        }
                    },
                    layout: {
                        padding: {
                            top: 10,
                            right: 20,
                            bottom: 10,
                            left: 20
                        }
                    }
                }
            };
            
            // Crear el gráfico
            new Chart(ctxMes, config);
        } catch (e) {
            console.error('Error al crear el gráfico:', e);
        }
    });
    </script>

    <h2 class="mt-5">Actividad mensual de Socios</h2>
    <div class="row">
        <div class="col-md-6 col-lg-3">
            <a href="?grupo=no_pago_sin_asistencia{% if filtro %}&filtro={{ filtro }}{% endif %}" class="text-decoration-none">
                <div class="card bg-danger text-white mb-3 shadow">
                    <div class="card-body">
                        <h5 class="card-title">No pago, sin asistencias</h5>
                        <p class="card-text fs-3">{{ socios_no_pago_sin_asistencia }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-3">
            <a href="?grupo=no_pago_con_asistencia{% if filtro %}&filtro={{ filtro }}{% endif %}" class="text-decoration-none">
                <div class="card bg-warning text-dark mb-3 shadow">
                    <div class="card-body">
                        <h5 class="card-title">No pago, con asistencias</h5>
                        <p class="card-text fs-3">{{ socios_no_pago_con_asistencia }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-3">
            <a href="?grupo=pago_sin_asistencia{% if filtro %}&filtro={{ filtro }}{% endif %}" class="text-decoration-none">
                <div class="card bg-secondary text-white mb-3 shadow">
                    <div class="card-body">
                        <h5 class="card-title">Pago, sin asistencias</h5>
                        <p class="card-text fs-3">{{ socios_con_pago_sin_asistencia }}</p>
                    </div>
                </div>
            </a>
        </div>
        <div class="col-md-6 col-lg-3">
            <a href="?grupo=pago_con_asistencia{% if filtro %}&filtro={{ filtro }}{% endif %}" class="text-decoration-none">
                <div class="card bg-primary text-white mb-3 shadow">
                    <div class="card-body">
                        <h5 class="card-title">Pago, con asistencias</h5>
                        <p class="card-text fs-3">{{ socios_con_pago_con_asistencia }}</p>
                    </div>
                </div>
            </a>
        </div>
    </div>

    {% if grupo %}
    <div class="card mt-4 shadow">
        <div class="card-body">
            <h4 class="card-title">{{ titulo_detalle }}</h4>
            <div class="table-responsive mt-3">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th class="sortable cursor-pointer text-nowrap" data-col="0">Nombre <span class="sort-icon">⇅</span></th>
                            <th class="sortable cursor-pointer text-nowrap" data-col="1">Días sin asistir <span class="sort-icon">⇅</span></th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for socio in socios_detalle %}
                        <tr>
                            <td>
                                {{ socio.nombre }} {{ socio.apellido }}
                                {% if not socio.has_all_data %}
                                    <i class="bi bi-info-circle-fill text-warning ms-1" title="Faltan datos opcionales"></i>
                                {% endif %}
                            </td>
                            <td>{{ socio.dias_sin_asistir }}</td>
                            <td>
                                {% if socio.telefono %}
                                <a href="https://wa.me/54{{ socio.telefono }}" target="_blank" class="ms-1 text-decoration-none" title="Enviar WhatsApp">
                                    <i class="bi bi-whatsapp text-success"></i>
                                </a>
                                {% endif %}
                                <a href="{% url 'socios:detalle_socio' socio.id %}"
                                class="text-info text-decoration-none" title="Ver detalle del socio">
                                    <i class="bi bi-person-lines-fill"></i>
                                </a>
                                <a href="{% url 'socios:editar_socio' socio.id %}" class="ms-1 text-decoration-none" title="Editar socio">
                                    <i class="bi bi-pencil-fill text-primary"></i>
                                </a>
                                <a href="{% url 'pagos:alta_pago' %}?socio_id={{ socio.id }}" class="ms-1 text-decoration-none" title="Registrar pago">
                                    <i class="bi bi-cash text-primary"></i>
                                </a>
                                <a href="{% url 'modalidades:cambiar_modalidad' socio.id %}" class="ms-1 text-decoration-none" title="Cambiar modalidad">
                                    <i class="bi bi-person-badge text-primary"></i>
                                </a>
                                <a href="{% url 'socios:gestionar_observaciones' socio.id %}" class="ms-1 text-decoration-none" title="Gestionar observaciones">
                                    <i class="bi bi-eye text-primary"></i>
                                </a>
                                <a href="{% url 'ejercicios:gestionar_registros' socio.id %}" class="ms-1 text-decoration-none" title="Gestionar ejercicios">
                                    <i class="bi bi-graph-up text-primary"></i>
                                </a>
                                <a href="{% url 'socios:eliminar_socio' socio.id %}" class="ms-1 text-decoration-none" title="Eliminar socio" onclick="return confirm('¿Seguro que querés borrar este registro?');">
                                    <i class="bi bi-trash3-fill text-primary"></i>
                                </a>
                            </td>
                        </tr>

                        {% empty %}
                        <tr><td colspan="5">No hay socios en este grupo.</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <a href="{% url 'home' %}?{% if filtro %}filtro={{ filtro }}{% endif %}" class="btn btn-outline-secondary mt-3">Ocultar detalle</a>
        </div>
    </div>
    {% endif %}

    <script>
    document.addEventListener('DOMContentLoaded', function () {
        function activarOrdenamiento() {
            const tabla = document.querySelector('.card table');
            if (!tabla) return;
            const headers = tabla.querySelectorAll('th.sortable');

            function ordenarTablaPorColumna(colIndex, asc = true) {
                const tbody = tabla.querySelector('tbody');
                const filas = Array.from(tbody.querySelectorAll('tr'));

                const filasOrdenadas = filas.sort((a, b) => {
                    const aText = a.children[colIndex].textContent.trim();
                    const bText = b.children[colIndex].textContent.trim();

                    const aNum = parseFloat(aText);
                    const bNum = parseFloat(bText);
                    const ambosNumeros = !isNaN(aNum) && !isNaN(bNum);

                    if (ambosNumeros) {
                        return asc ? aNum - bNum : bNum - aNum;
                    } else {
                        return asc
                            ? aText.localeCompare(bText)
                            : bText.localeCompare(aText);
                    }
                });

                filasOrdenadas.forEach(fila => tbody.appendChild(fila));
            }

            function actualizarIconosYClases(clickedHeader, asc) {
                headers.forEach(h => {
                    h.classList.remove('asc', 'desc');
                    const icon = h.querySelector('.sort-icon');
                    if (icon) icon.textContent = '⇅';
                });

                clickedHeader.classList.add(asc ? 'asc' : 'desc');
                const icon = clickedHeader.querySelector('.sort-icon');
                if (icon) icon.textContent = asc ? '▲' : '▼';
            }

            headers.forEach(header => {
                header.addEventListener('click', () => {
                    const colIndex = parseInt(header.dataset.col);
                    const isCurrentlyAsc = header.classList.contains('asc');
                    const asc = !isCurrentlyAsc;

                    ordenarTablaPorColumna(colIndex, asc);
                    actualizarIconosYClases(header, asc);
                });
            });

            if (headers.length > 0 && !document.body.classList.contains('ordenamiento-home-inicial')) {
                const defaultHeader = headers[0];
                ordenarTablaPorColumna(0, true);
                actualizarIconosYClases(defaultHeader, true);
                document.body.classList.add('ordenamiento-home-inicial');
            }
        }

        activarOrdenamiento();
    });
</script>

</div>
{% endblock %}
