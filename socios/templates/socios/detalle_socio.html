{% extends 'base.html' %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2>Detalle de Socio</h2>

    <div class="card mb-4">
        <div class="card-body">
            <h5 class="card-title">{{ socio.nombre }} {{ socio.apellido }}</h5>
            <p class="card-text"><strong>Fecha de Nacimiento:</strong> 
                {% if socio.fecha_nacimiento %}
                    {{ socio.fecha_nacimiento|date:"d/m/Y" }}
                {% else %}
                    No especificada
                {% endif %}
            </p>
            <p class="card-text"><strong>Teléfono:</strong> {{ socio.telefono }}</p>
            <p class="card-text"><strong>Email:</strong> {{ socio.email }}</p>
            <p class="card-text">
                <strong>Estado de Cuota:</strong> 
                <span class="badge bg-{{ color_cuota }}">{{ estado_cuota }}</span>
            </p>
            {% if modalidad_actual %}
            <p class="card-text"><strong>Modalidad Actual:</strong> {{ modalidad_actual.modalidad.nombre }} (${{ modalidad_actual.precio_en_el_momento }})</p>
            {% else %}
            <p class="card-text"><strong>Modalidad Actual:</strong> No asignada</p>
            {% endif %}

        </div>
    </div>

    <h3>Historial de Pagos</h3>
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Fecha de Pago</th>
                <th>Monto</th>
                <th>Fecha de Vencimiento</th>
            </tr>
        </thead>
        <tbody>
            {% for pago in pagos %}
                <tr>
                    <td>{{ pago.fecha_pago|date:"d/m/Y" }}</td>
                    <td>${{ pago.monto }}</td>
                    <td>{{ pago.fecha_vencimiento|date:"d/m/Y" }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="3">No hay pagos registrados aún.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3>Historial de Modalidades</h3>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Fecha Inicio</th>
                <th>Fecha Fin</th>
                <th>Modalidad</th>
                <th>Precio</th>
            </tr>
        </thead>
        <tbody>
            {% for cambio in historial_modalidades %}
                <tr>
                    <td>{{ cambio.fecha_inicio|date:"d/m/Y" }}</td>
                    <td>
                        {% if cambio.fecha_fin %}
                            {{ cambio.fecha_fin|date:"d/m/Y" }}
                        {% else %}
                            Actual
                        {% endif %}
                    </td>
                    <td>{{ cambio.modalidad.nombre }}</td>
                    <td>${{ cambio.precio_en_el_momento }}</td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="4">No hay historial de modalidades registrado.</td>
                </tr>
            {% endfor %}
        </tbody>
    </table>

    <h3>Historial de Asistencias</h3>

    {% if asistencias %}
        <ul class="list-group mb-4">
            {% for asistencia in asistencias %}
                <li class="list-group-item">
                    {{ asistencia.fecha_hora|date:"d/m/Y H:i" }}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay asistencias registradas.</p>
    {% endif %}


    <h3>Historial de Observaciones</h3>

    {% if observaciones %}
        <ul class="list-group mb-4">
            {% for observacion in observaciones %}
                <li class="list-group-item {% if observacion.activa %}list-group-item-warning{% else %}list-group-item-light{% endif %}">
                    {{ observacion.descripcion }}<br>
                    <small>
                        Desde: {{ observacion.fecha_inicio|date:"d/m/Y" }}
                        {% if observacion.fecha_fin %} hasta {{ observacion.fecha_fin|date:"d/m/Y" }}{% endif %}
                    </small>
                    {% if observacion.activa %}
                        <span class="badge bg-warning text-dark ms-2">Activa</span>
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
    {% else %}
        <p>No hay observaciones registradas.</p>
    {% endif %}


    <h3>Historial de Ejercicios</h3>

    <form method="get" class="mb-4" id="form-ejercicio">
        <div class="input-group">
            <select name="ejercicio_id" class="form-select" onchange="document.getElementById('form-ejercicio').submit()">
                <option value="">-- Seleccionar ejercicio --</option>
                {% for ejercicio in ejercicios %}
                    <option value="{{ ejercicio.id }}" {% if ejercicio_seleccionado and ejercicio.id == ejercicio_seleccionado.id %}selected{% endif %}>
                        {{ ejercicio.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>
    </form>

    {% if registros_ejercicio %}
        <div class="row mt-4">
            {% if registros_ejercicio %}
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Evolución de Peso - {{ ejercicio_seleccionado.nombre }}</h5>
                            <small class="text-muted">{{ registros_ejercicio|length }} registro{{ registros_ejercicio|length|pluralize }} encontrado{{ registros_ejercicio|length|pluralize }}</small>
                        </div>
                        <div class="card-body">
                            <div style="height: 300px;">
                                <canvas id="pesoChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            {% else %}
                <div class="col-12 mb-4">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Se necesita más de un registro para mostrar el gráfico de evolución.
                    </div>
                </div>
            {% endif %}
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Registros</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Peso (kg)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for registro in registros_ejercicio %}
                                        <tr>
                                            <td>{{ registro.fecha|date:"d/m/Y" }}</td>
                                            <td>{{ registro.peso }}</td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% elif ejercicio_seleccionado %}
        <p>No hay registros para el ejercicio seleccionado.</p>
    {% endif %}


    <a href="{% url 'socios:listar_socios' %}" class="btn btn-secondary mt-3">Volver</a>
</div>
{% endblock %}

{% block extra_js %}
{% if registros_ejercicio %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('Inicializando gráfico...');
    
    // 1. Obtener los datos de Django
    const registrosEjercicio = [
        {% for registro in registros_ejercicio|dictsort:"fecha" %}
            {
                fecha: '{{ registro.fecha|date:"d/m/Y" }}',
                peso: parseFloat({{ registro.peso|stringformat:".1f" }})
            }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    // Si solo hay un registro, lo duplicamos para poder mostrar el gráfico
    if (registrosEjercicio.length === 1) {
        const unicoRegistro = registrosEjercicio[0];
        registrosEjercicio.push({
            ...unicoRegistro,
            // Usamos la misma fecha para el segundo punto
            fecha: unicoRegistro.fecha
        });
    }
    
    // 2. Preparar datos para el gráfico
    const fechas = registrosEjercicio.map(r => r.fecha);
    const pesos = registrosEjercicio.map(r => r.peso);
    
    console.log('Datos del gráfico:', { fechas, pesos });
    
    // 3. Obtener el contexto del canvas
    const ctx = document.getElementById('pesoChart').getContext('2d');
    if (!ctx) {
        console.error('No se pudo obtener el contexto del canvas');
        return;
    }
    
    // 4. Crear el gráfico con los datos reales
    try {
        console.log('Creando gráfico con datos reales...');
        
        const myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: fechas,
                datasets: [{
                    label: 'Peso (kg)',
                    data: pesos,
                    borderColor: 'rgb(78, 115, 223)',
                    backgroundColor: 'rgba(78, 115, 223, 0.1)',
                    borderWidth: 2,
                    pointRadius: 4,
                    pointBackgroundColor: '#4e73df',
                    pointBorderColor: '#fff',
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: '#2e59d9',
                    pointHoverBorderColor: '#fff',
                    pointHitRadius: 10,
                    pointBorderWidth: 2,
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Peso (kg)'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + ' kg';
                            }
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Fecha'
                        }
                    }
                },
                plugins: {
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Peso: ${context.parsed.y} kg`;
                            }
                        }
                    }
                }
            }
        });
        
        console.log('Gráfico creado exitosamente');
        
    } catch (error) {
        console.error('Error al crear el gráfico:', error);
    }
});
</script>
{% endif %}
{% endblock %}


