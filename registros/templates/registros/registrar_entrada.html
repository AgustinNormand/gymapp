{% extends 'base.html' %}
{% load dict_filters %}
{% block title %}Registrar Asistencia{% endblock %}
{% block content %}
<h2>Registrar Asistencia</h2>

<form method="POST" action="{% url 'confirmar_entrada' %}" id="formEntrada">
    {% csrf_token %}
    <div class="mb-3">
        <label for="busquedaSocio" class="form-label">Buscar socio</label>
        <input type="text" id="busquedaSocio" class="form-control" placeholder="Nombre o apellido" autocomplete="off">
        <ul class="list-group mt-1" id="resultadosBusqueda"></ul>
        <input type="hidden" name="socio_id" id="socioID">
    </div>
</form>

<hr>
<h4 class="mt-4">Asistencias registradas en esta hora</h4>
<table class="table table-sm align-middle text-nowrap">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Observaciones</th>
            <th>Cuota</th>
            <th>Asistencias</th>
            {% for ejercicio in ejercicios %}
            <th class="text-center">{{ ejercicio.nombre }}</th>
            {% endfor %}

            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for entrada in entradas_hora %}
        <tr>
            <td class="text-center">
                {{ entrada.socio.nombre }} {{ entrada.socio.apellido }}
            </td>
            <td class="text-center">
                {% with entrada.socio as socio %}
                    {% for obs in socio.get_observaciones_activas %}
                        <a href="{% url 'socios:gestionar_observaciones' socio.id %}" class="text-decoration-none">
                            <i class="bi bi-exclamation-triangle-fill text-warning me-1"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               title="{{ obs.descripcion }}"></i>
                        </a>
                    {% endfor %}
            
                    {% for obs in socio.get_observaciones_pasadas %}
                        <a href="{% url 'socios:gestionar_observaciones' socio.id %}" class="text-decoration-none">
                            <i class="bi bi-clock-fill text-secondary me-1"
                               data-bs-toggle="tooltip"
                               data-bs-placement="top"
                               title="{{ obs.descripcion }}"></i>
                        </a>
                    {% endfor %}
            
                    {% if not socio.get_observaciones_activas and not socio.get_observaciones_pasadas %}
                        <a href="{% url 'socios:gestionar_observaciones' socio.id %}" class="text-decoration-none">
                            <i class="bi bi-check-circle-fill text-success"
                               data-bs-toggle="tooltip" title="Sin observaciones"></i>
                        </a>
                    {% endif %}
                {% endwith %}
            </td>
            
            <td class="text-center">
                {% with estado=entrada.socio.estado_cuota %}
                    {% if estado == 'al_dia' %}
                        <i class="bi bi-check-circle-fill text-success" title="Cuota al día" data-bs-toggle="tooltip"></i>
                    {% elif estado == 'por_vencer' %}
                        <i class="bi bi-check-circle-fill text-warning" title="Cuota por vencer" data-bs-toggle="tooltip"></i>
                    {% else %}
                        <i class="bi bi-exclamation-triangle-fill text-danger" title="Cuota vencida" data-bs-toggle="tooltip"></i>
                    {% endif %}
                {% endwith %}
            </td>
            
            <td class="text-center">
                {% if entrada.socio.excedio_asistencias_semanales %}
                    <i class="bi bi-exclamation-diamond-fill text-danger" data-bs-toggle="tooltip" title="Superó el límite semanal de asistencias según su modalidad"></i>
                {% else %}
                    <i class="bi bi-check-circle-fill text-success" data-bs-toggle="tooltip" title="Dentro del límite semanal"></i>
                {% endif %}
            </td>
            

            {% for ejercicio in ejercicios %}
                <td class="text-center">
                    {% with peso=entrada.socio.pesos_por_ejercicio|dict_get:ejercicio.id %}
                        {% if peso %}
                            {{ peso }} kg
                        {% else %}
                            <span class="text-muted">—</span>
                        {% endif %}
                    {% endwith %}
                </td>
            {% endfor %}

            
            <td class="text-center">
                <a href="{% url 'socios:detalle_socio' entrada.socio.id %}"
                   class="text-info text-decoration-none" title="Ver detalle del socio">
                    <i class="bi bi-person-lines-fill"></i>
                </a>
                <a href="{% url 'socios:editar_socio' entrada.socio.id %}" class="ms-1 text-decoration-none" title="Editar socio">
                    <i class="bi bi-pencil-fill text-primary"></i>
                </a>
                <a href="{% url 'eliminar_entrada' entrada.id %}"
                   onclick="return confirm('¿Estás seguro de que querés eliminar esta asistencia?')"
                   class="text-danger text-decoration-none" title="Eliminar asistencia">
                    <i class="bi bi-x-circle-fill"></i>
                </a>
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="4" class="text-center text-muted">No hay asistencias registradas esta hora.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const input = document.getElementById("busquedaSocio");
    const resultados = document.getElementById("resultadosBusqueda");
    const inputHidden = document.getElementById("socioID");
    const form = document.getElementById("formEntrada");
    let seleccionIndex = -1;

    function seleccionarSocio(socio) {
        input.value = socio.nombre_completo;
        inputHidden.value = socio.id;
        resultados.innerHTML = "";
        form.submit();  // ✅ enviar automáticamente
    }

    input.addEventListener("input", function () {
        const q = this.value;
        if (q.length < 1) {
            resultados.innerHTML = "";
            return;
        }

        fetch("{% url 'buscar_socios' %}?q=" + encodeURIComponent(q))
            .then(res => res.json())
            .then(data => {
                resultados.innerHTML = "";
                seleccionIndex = 0;  // ✅ Primer elemento seleccionado por defecto
                data.forEach((socio, idx) => {
                    const li = document.createElement("li");
                    li.className = "list-group-item list-group-item-action";
                    li.textContent = socio.nombre_completo;
                    li.dataset.id = socio.id;
                    if (idx === 0) li.classList.add("active");  // ✅ Resalta el primero
                    li.addEventListener("click", () => seleccionarSocio(socio));
                    resultados.appendChild(li);
                });
            });

    });

    input.addEventListener("keydown", function (e) {
        const items = resultados.querySelectorAll("li");

        if (e.key === "ArrowDown") {
            if (seleccionIndex < items.length - 1) seleccionIndex++;
        } else if (e.key === "ArrowUp") {
            if (seleccionIndex > 0) seleccionIndex--;
        } else if (e.key === "Enter") {
            e.preventDefault();
            if (seleccionIndex >= 0 && items[seleccionIndex]) {
                const socio = {
                    id: items[seleccionIndex].dataset.id,
                    nombre_completo: items[seleccionIndex].textContent
                };
                seleccionarSocio(socio);
            }
        }

        items.forEach((item, idx) => {
            item.classList.toggle("active", idx === seleccionIndex);
        });
    });
});
</script>
{% endblock %}
