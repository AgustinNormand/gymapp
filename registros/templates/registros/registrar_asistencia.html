{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2>Registrar asistencia</h2>
    <input type="text" id="input-buscar-socio" class="form-control" placeholder="Buscar socio por nombre o apellido...">
    <div id="mensaje-exito" class="mt-3"></div>
    <div id="resultados" class="list-group mt-2"></div>
    <h3 class="mt-5">Socios con asistencia confirmada:</h3>
    <div id="listado-socios" class="mt-3"></div>
</div>

<script>
    const inputBuscar = document.getElementById('input-buscar-socio');
    const resultados = document.getElementById('resultados');
    let indiceSeleccionado = -1;
    let resultadosArray = [];
    
    inputBuscar.addEventListener('input', function() {
        const texto = inputBuscar.value.trim();
        if (texto.length > 1) {
            fetch(`/registros/buscar_socios/?q=${texto}`)
                .then(response => response.json())
                .then(data => {
                    resultadosArray = data;
                    mostrarResultados();
                });
        } else {
            resultadosArray = [];
            mostrarResultados();
        }
    });
    
    inputBuscar.addEventListener('keydown', function(event) {
        if (event.key === 'ArrowDown') {
            event.preventDefault();
            if (indiceSeleccionado < resultadosArray.length - 1) {
                indiceSeleccionado++;
                actualizarSeleccion();
            }
        } else if (event.key === 'ArrowUp') {
            event.preventDefault();
            if (indiceSeleccionado > 0) {
                indiceSeleccionado--;
                actualizarSeleccion();
            }
        } else if (event.key === 'Enter') {
            event.preventDefault();
            if (indiceSeleccionado >= 0 && indiceSeleccionado < resultadosArray.length) {
                const socio = resultadosArray[indiceSeleccionado];
                registrarAsistencia(socio.id);
            }
        }
    });
    
    function mostrarResultados() {
        resultados.innerHTML = '';
        resultadosArray.forEach((socio, index) => {
            const div = document.createElement('button');
            div.type = "button";
            div.textContent = socio.nombre_completo;
            div.classList.add('list-group-item', 'list-group-item-action');  // üî• Bootstrap classes
            div.dataset.index = index;
            div.addEventListener('click', function() {
                registrarAsistencia(socio.id);
            });
            resultados.appendChild(div);
        });

        if (resultadosArray.length > 0) {
            indiceSeleccionado = 0;
            actualizarSeleccion();
        } else {
            indiceSeleccionado = -1;
        }
    }


    
    function actualizarSeleccion() {
        const items = resultados.querySelectorAll('.list-group-item');
        items.forEach(item => item.classList.remove('active'));
        if (items[indiceSeleccionado]) {
            items[indiceSeleccionado].classList.add('active');
        }
    }

    
    function registrarAsistencia(socioId) {
        fetch('/registros/registrar_asistencia_ajax/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({ id: socioId })  // CAMBIAMOS AC√Å
        })
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                alert(data.error);
            } else {
                mostrarSocio(data);
                mostrarMensajeExito(`‚úÖ Asistencia registrada para ${data.socio}`);
                inputBuscar.value = '';
                resultados.innerHTML = '';
                resultadosArray = [];
            }
        });

    }

    function mostrarMensajeExito(mensaje) {
        const mensajeDiv = document.getElementById('mensaje-exito');
        mensajeDiv.innerHTML = `
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                ${mensaje}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
            </div>
        `;
    }
    
    let haySociosRegistrados = false;

    // Cuando registramos una asistencia exitosamente:
    function mostrarSocio(data) {
        const listado = document.getElementById('listado-socios');
        const div = document.createElement('div');
        div.classList.add('card', 'p-2', 'mb-2', 'shadow-sm', 'position-relative');
        div.dataset.registroId = data.registro_id;  // Guardamos el ID para despu√©s

        div.innerHTML = `
            <button type="button" class="btn-close position-absolute top-0 end-0 m-2" aria-label="Cerrar"></button>
            <strong>${data.socio}</strong><br>
            <small><b>Estado de cuota:</b> ${data.cuota}</small><br>
            <small><b>Observaciones:</b> ${data.observaciones.length ? data.observaciones.join(', ') : 'Ninguna'}</small><br>
            <small><b>Pesos:</b> ${Object.keys(data.pesos).length ? Object.entries(data.pesos).map(([ej, kg]) => `${ej}: ${kg}kg`).join(', ') : 'Sin registros'}</small>
        `;

        const botonCerrar = div.querySelector('.btn-close');
        botonCerrar.addEventListener('click', function() {
            if (confirm("¬øSeguro que quer√©s borrar esta asistencia?")) {
                const registroId = div.dataset.registroId;
                fetch('/registros/borrar_asistencia_ajax/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ registro_id: registroId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'ok') {
                        div.remove();
                        mostrarMensajeExito('‚úÖ Asistencia eliminada correctamente.');
                    } else {
                        alert(data.error || 'Error al borrar la asistencia.');
                    }
                });
            }
        });

        listado.prepend(div);
    }



    // Ahora, detectamos si se intenta salir
    window.addEventListener('beforeunload', function (e) {
        if (haySociosRegistrados) {
            e.preventDefault();
            e.returnValue = ''; // Algunos navegadores necesitan esta l√≠nea
            // El mensaje real lo muestra el navegador autom√°ticamente
        }
    });

    
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    </script>
{% endblock %}


    